generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//////////////////// ENUMS ////////////////////

enum Role {
  PLAYER
  OWNER
  EMPLOYEE
  ADMIN
}

enum SkillLevel {
  WEAK
  AVERAGE
  GOOD
  EXCELLENT
  LEGENDARY
}

enum FieldType {
  FOOTBALL
  PADEL
}

enum FieldStatus {
  OPEN
  CLOSED
  MAINTENANCE
}

enum SlotStatus {
  AVAILABLE
  AVAILABLE_NEEDS_CONFIRM
  TEMP_LOCKED
  PENDING_CONFIRMATION
  BOOKED
}

enum BookingStatus {
  PENDING_CONFIRMATION
  CONFIRMED
  CANCELLED
  FAILED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

//////////////////// USER ////////////////////

model User {
  id            String   @id @default(cuid())
  name          String
  email         String   @unique
  passwordHash String

  phoneNumber String?  @unique
  age         Int?
  avatar      String?
  description String?
  skillLevel  SkillLevel @default(AVERAGE)

  role        Role @default(PLAYER)

  // üîê Auth & Security
  isVerified    Boolean   @default(true)
  isActive      Boolean   @default(true)
  loginAttempts Int       @default(0)
  lockedUntil   DateTime?
  lastLogin     DateTime?

  // üîó Relations
  bookings      Booking[]
  slotsLocked   Slot[]        @relation("SlotLockedByUser")
  notifications Notification[]
  flags         FlaggedUser[]
  auditLogs     AuditLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([role])
  @@index([createdAt])
}

//////////////////// FIELD ////////////////////

model Field {
  id          String @id @default(cuid())
  name        String
  description String?
  location    String
  address     String?

  type     FieldType
  imageUrl String?

  pricePerHour   Float
  depositPrice   Float
  openingTime    String
  closingTime    String
  slotDurationMin Int @default(60)

  status     FieldStatus @default(OPEN)
  facilities String[]

  slots    Slot[]
  bookings Booking[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type])
  @@index([location])
}

//////////////////// SLOT ////////////////////

model Slot {
  id      String @id @default(cuid())
  fieldId String
  field   Field  @relation(fields: [fieldId], references: [id])

  startTime DateTime
  endTime   DateTime

  status      SlotStatus @default(AVAILABLE)
  lockedUntil DateTime?

  lockedByUserId String?
  lockedByUser   User? @relation("SlotLockedByUser", fields: [lockedByUserId], references: [id])

  booking Booking?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([fieldId, startTime])
  @@index([status, lockedUntil])
  @@index([lockedByUserId])
}

//////////////////// BOOKING ////////////////////

model Booking {
  id String @id @default(cuid())

  userId String
  user   User @relation(fields: [userId], references: [id])

  fieldId String
  field   Field @relation(fields: [fieldId], references: [id])

  slotId String @unique
  slot   Slot @relation(fields: [slotId], references: [id])

  status        BookingStatus
  paymentStatus PaymentStatus @default(PENDING)

  totalAmount Float
  depositPaid Float?

  refundableUntil DateTime?

  cancelReason String?
  cancelNotes  String?

  confirmedBy String?
  confirmedAt DateTime?

  payments Payment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([fieldId])
  @@index([status])
}

//////////////////// PAYMENT ////////////////////

model Payment {
  id String @id @default(cuid())

  bookingId String
  booking   Booking @relation(fields: [bookingId], references: [id])

  amount   Float
  currency String @default("EGP")

  paymentId String?
  orderId   String?

  status   PaymentStatus @default(PENDING)
  metadata Json?

  refundedAmount Float @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([bookingId])
}

//////////////////// NOTIFICATIONS ////////////////////
model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])

  bookingId String?      // ‚úÖ ÿπŸÖŸàÿØ ÿßÿÆÿ™Ÿäÿßÿ±Ÿä
  booking   Booking?     @relation(fields: [bookingId], references: [id])

  type      String
  title     String
  message   String
  data      Json?

  isRead    Boolean   @default(false)
  createdAt DateTime  @default(now())

  @@index([userId, isRead])
  @@index([bookingId])
}

//////////////////// FLAGGED USERS ////////////////////

model FlaggedUser {
  id     String @id @default(cuid())
  userId String
  user   User @relation(fields: [userId], references: [id])

  reason    String
  severity  String @default("MEDIUM")
  expiresAt DateTime?

  createdAt DateTime @default(now())

  @@index([userId])
}

//////////////////// AUDIT LOG ////////////////////

model AuditLog {
  id String @id @default(cuid())

  userId String?
  user   User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  action     String
  entityType String?
  entityId   String?
  oldValue   Json?
  newValue   Json?
  ipAddress  String?
  userAgent  String?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([action])
}
