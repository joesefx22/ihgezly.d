// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===================== ENUMS =====================
enum UserRole {
  PLAYER
  EMPLOYEE
  ADMIN
}

enum FieldType {
  FOOTBALL
  PADEL
}

enum FieldStatus {
  OPEN
  CLOSED
  MAINTENANCE
}

enum SlotStatus {
  AVAILABLE
  AVAILABLE_NEEDS_CONFIRM
  TEMP_LOCKED
  PENDING_CONFIRMATION
  BOOKED
}

enum BookingStatus {
  PENDING_CONFIRMATION
  CONFIRMED
  CANCELLED
  FAILED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

// ===================== MODELS =====================
model User {
  id           String   @id @default(cuid())
  name         String
  email        String   @unique
  passwordHash String
  role         UserRole @default(PLAYER)

  phone  String?
  avatar String?

  bookings      Booking[]
  notifications Notification[]
  flags         FlaggedUser[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
}

model Field {
  id          String  @id @default(cuid())
  name        String
  description String?
  location    String
  address     String?

  type     FieldType
  imageUrl String?

  pricePerHour Float
  depositPrice Float

  openingTime     String
  closingTime     String
  slotDurationMin Int    @default(60)

  status     FieldStatus @default(OPEN)
  facilities String[]

  slots    Slot[]
  bookings Booking[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type])
  @@index([location])
}

model Slot {
  id      String @id @default(cuid())
  fieldId String
  field   Field  @relation(fields: [fieldId], references: [id])

  startTime DateTime
  endTime   DateTime

  status      SlotStatus @default(AVAILABLE)
  lockedUntil DateTime?

  booking Booking?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([fieldId, startTime])
  @@index([fieldId, startTime, status])
  @@index([status, lockedUntil])
}

model Booking {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id])

  fieldId String
  field   Field  @relation(fields: [fieldId], references: [id])

  slotId String @unique
  slot   Slot   @relation(fields: [slotId], references: [id])

  status        BookingStatus
  paymentStatus PaymentStatus @default(PENDING)

  totalAmount Float
  depositPaid Float?

  refundableUntil DateTime?

  cancelReason String?
  cancelNotes  String?

  confirmedBy String?
  confirmedAt DateTime?

  payments Payment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([fieldId])
  @@index([status])
  @@index([createdAt])
}

model Payment {
  id String @id @default(cuid())

  bookingId String
  booking   Booking @relation(fields: [bookingId], references: [id])

  amount   Float
  currency String @default("EGP")

  paymentId String?
  orderId   String?

  status   PaymentStatus @default(PENDING)
  metadata Json?

  refundedAmount Float @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([bookingId])
  @@index([paymentId])
}

model Notification {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  type    String
  title   String
  message String
  data    Json?

  isRead    Boolean @default(false)
  relatedId String?

  createdAt DateTime @default(now())

  @@index([userId, isRead])
}

model FlaggedUser {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  reason    String
  severity  String    @default("MEDIUM")
  expiresAt DateTime?

  createdAt DateTime @default(now())

  @@index([userId])
}
