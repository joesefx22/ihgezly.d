// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===================== ENUMS =====================
enum UserRole {
  PLAYER
  EMPLOYEE
  ADMIN
}

enum FieldType {
  FOOTBALL
  PADEL
}

enum FieldStatus {
  OPEN
  CLOSED
  MAINTENANCE
}

enum SlotStatus {
  AVAILABLE
  TEMP_LOCKED
  NEED_CONFIRMATION
  BOOKED
}

enum BookingStatus {
  PENDING_CONFIRMATION
  CONFIRMED
  CANCELLED
  FAILED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

// ===================== MODELS =====================
model User {
  id            String    @id @default(cuid())
  name          String
  email         String    @unique
  passwordHash  String
  role          UserRole  @default(PLAYER)
  phone         String?
  avatar        String?
  
  bookings      Booking[]
  notifications Notification[]
  flags         FlaggedUser[]
  
  dailyBookings Int       @default(0)
  weeklyBookings Int      @default(0)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([email])
}

model Field {
  id              String      @id @default(cuid())
  name            String
  description     String?
  location        String      // المنطقة (المقطم، الهضبة)
  address         String?
  type            FieldType
  imageUrl        String?
  
  pricePerHour    Float
  depositPrice    Float
  
  openingTime     String      // "08:00"
  closingTime     String      // "23:00"
  slotDuration    Int         @default(60) // بالدقائق
  
  status          FieldStatus @default(OPEN)
  facilities      String[]    // ["تغير ملابس", "باركينج", "إضاءة"]
  
  slots           Slot[]
  bookings        Booking[]
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  @@index([type])
  @@index([location])
}

model Slot {
  id          String     @id @default(cuid())
  fieldId     String
  field       Field      @relation(fields: [fieldId], references: [id])
  
  startTime   DateTime   // الوقت الفعلي للحجز (UTC)
  endTime     DateTime
  
  status      SlotStatus @default(AVAILABLE)
  lockedUntil DateTime?  // للـ race condition (5 دقائق)
  
  booking     Booking?
  
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  
  @@unique([fieldId, startTime])
  @@index([fieldId, startTime, status])
}

model Booking {
  id              String         @id @default(cuid())
  
  userId          String
  user            User           @relation(fields: [userId], references: [id])
  
  fieldId         String
  field           Field          @relation(fields: [fieldId], references: [id])
  
  slotId          String
  slot            Slot           @relation(fields: [slotId], references: [id])
  
  status          BookingStatus
  paymentStatus   PaymentStatus  @default(PENDING)
  
  totalAmount     Float
  depositPaid     Float?
  
  paymentId       String?        // من Paymob
  paymentMethod   String?
  
  refundableUntil DateTime?      // آخر موعد للاسترداد
  
  cancelReason    String?
  cancelNotes     String?
  
  confirmedBy     String?        // id الموظف اللي وافق
  confirmedAt     DateTime?
  
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  @@index([userId])
  @@index([fieldId])
  @@index([status])
  @@index([createdAt])
}

model Payment {
  id          String        @id @default(cuid())
  bookingId   String
  booking     Booking       @relation(fields: [bookingId], references: [id])
  
  amount      Float
  currency    String        @default("EGP")
  
  paymentId   String?       // من Paymob
  orderId     String?
  
  status      PaymentStatus @default(PENDING)
  metadata    Json?         // رد Paymob الكامل
  
  refundedAmount Float?     @default(0)
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  @@index([bookingId])
  @@index([paymentId])
}

model Notification {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  
  type        String   // "BOOKING_NEEDS_CONFIRMATION", "BOOKING_CONFIRMED", etc
  
  title       String
  message     String
  data        Json?    // بيانات إضافية
  
  isRead      Boolean  @default(false)
  
  relatedId   String?  // bookingId أو غيره
  
  createdAt   DateTime @default(now())
  
  @@index([userId, isRead])
}

model FlaggedUser {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  
  reason      String
  severity    String   @default("MEDIUM") // LOW, MEDIUM, HIGH
  
  createdAt   DateTime @default(now())
  expiresAt   DateTime? // مدة التقييد
  
  @@index([userId])
}
